<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Web</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <style>
        #map {
            height: 900px;
            width: 100%;
        }

        /* CSS cho danh sách gợi ý */
        .suggestions {
            border: 1px solid #ddd;
            max-height: 150px;
            overflow-y: auto;
        }

        .suggestion-item {
            padding: 8px;
            cursor: pointer;
            background-color: white;
        }

        .suggestion-item:hover {
            background-color: #f0f0f0;
        }

        .trip-table {
            width: 100%;
            border-collapse: collapse;
        }

        .trip-table th,
        .trip-table td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        .trip-table th {
            background-color: #f2f2f2;
            text-align: left;
        }

        .trip-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .trip-table tr:hover {
            background-color: #ddd;
        }
    </style>
</head>

<body>
    <div>
        <label for="loc_source">Điểm đón:</label>
        <input type="text" id="loc_source" placeholder="Nhập điểm đón">
        <ul id="sourceSuggestions" class="suggestions"></ul> <!-- Danh sách gợi ý -->
        <br>
        <label for="loc_destination">Điểm trả:</label>
        <input type="text" id="loc_destination" placeholder="Nhập điểm trả">
        <ul id="destinationSuggestions" class="suggestions"></ul> <!-- Danh sách gợi ý -->
        <br>
        <!-- Nút Search -->
        <button id="searchBtn">Search</button>
        <!-- Nút Create -->
        <button id="createBtn">Create</button>
        <div id="routeInfo">
        </div>
        <!-- Phần hiển thị danh sách tài xế gần nhât backend gửi lên -->
        <ul id="driverList"></ul>


        <button id="myTripBtn">My Trip</button>
        <button id="backBtn" style="display: none;">Back</button>
        <button id="loadMoreBtn" style="display: none;">Load More</button>
        <button id="nextBtn" style="display: none;">Next</button>

        <!-- Hiển thị danh sách các chuyến đi -->
        <div id="tripList" style="display: none;">
            <table id="tripTable" class="trip-table">
                <thead>
                    <tr>
                        <th>Trip ID</th>
                        <th>Status</th>
                        <th>Source</th>
                        <th>Destination</th>
                        <th>Created At</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Hàng dữ liệu sẽ được chèn vào đây -->
                </tbody>
            </table>
        </div>

        <!-- Hiển thị thông tin chi tiết chuyến đi -->
        <div id="tripDetail"></div>

        <!-- Hiển thị form đánh giá -->
        <div id="tripRating" style="display: none;">
            <div id="ratingForm">
                <label for="rating">Rating:</label>
                <select id="rating">
                    <option value="1">1 Star</option>
                    <option value="2">2 Stars</option>
                    <option value="3">3 Stars</option>
                    <option value="4">4 Stars</option>
                    <option value="5">5 Stars</option>
                </select><br>

                <label for="feedback">Feedback:</label>
                <textarea id="feedback" rows="4" cols="50" placeholder="Leave your feedback..."></textarea><br>

                <button id="sendRatingBtn">Send</button>
            </div>
        </div>

        <!-- Hiển thị form payment khi click vào tài xế -->
        <div id="tripPayment" style="display: none;">
            <div id="paymentForm">
                <label for="payment">Payment</label>
                <div id="paymentDetail">
                    <!-- Price, Voucher, Total  -->
                </div>
                <select id="method">
                    <option value="1">Cash</option>
                    <option value="2">E-Wallet</option>
                    <option value="3">Banking Online</option>
                </select>

                <!-- Button Confirm -->
                <button id="payNowBtn">Pay Now</button>
                <button id="okBtn">Ok</button>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script>
        let customerId = 1234;
        var map = L.map('map').setView([21.0285, 105.8542], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        let locSourceMarker, locDestinationMarker, routeLayer;

        // --------------------------- Chọn điểm đón, trả --------------------------
        // Hàm đánh dấu vị trí
        function markLocation(lat, lon, display_name, isSource) {
            if (isSource) {
                // Xóa marker cũ của điểm đón nếu có
                if (locSourceMarker) {
                    map.removeLayer(locSourceMarker);
                    delete locSourceMarker;
                }
                // Thêm marker mới cho điểm đón
                locSourceMarker = L.marker([lat, lon]).addTo(map).bindPopup('Điểm đón').openPopup();
                localStorage.setItem('loc_source', JSON.stringify({ lat, lon, display_name }));

                // Xóa tuyến đường cũ khi thay đổi điểm đón: nếu không thì vẫn sẽ thấy điểm đón cũ BỞI VÌ marker thì đã mất(do xóa ở trên) nhưng route thì vẫn còn đó (route và 2 điểm đón, trả là dộc lập với nhau. Xóa đón trả ko đồng nghĩa xóa được route)
                if (routeLayer) {
                    map.removeControl(routeLayer);
                }
            } else {
                // Xóa marker cũ của điểm trả nếu có
                if (locDestinationMarker) {
                    map.removeLayer(locDestinationMarker);
                    delete locDestinationMarker;
                }
                // Thêm marker mới cho điểm trả
                locDestinationMarker = L.marker([lat, lon]).addTo(map).bindPopup('Điểm trả').openPopup();
                localStorage.setItem('loc_destination', JSON.stringify({ lat, lon, display_name }));

                // Xóa tuyến đường cũ khi thay đổi điểm trả
                if (routeLayer) {
                    map.removeControl(routeLayer);
                }
            }

            // Kiểm tra và vẽ lại tuyến đường khi cả hai điểm đón và trả đã có
            const storedSource = JSON.parse(localStorage.getItem('loc_source'));
            const storedDestination = JSON.parse(localStorage.getItem('loc_destination'));
            if (storedSource && storedDestination) {
                drawRoute(storedSource, storedDestination);
            }
        }

        // Hàm vẽ tuyến đường
        function drawRoute(source, destination) {
            // Xóa tuyến đường cũ nếu có
            if (routeLayer) {
                map.removeControl(routeLayer);
            }

            // Vẽ tuyến đường mới
            routeLayer = L.Routing.control({
                waypoints: [
                    L.latLng(source.lat, source.lon),
                    L.latLng(destination.lat, destination.lon)
                ],
                routeWhileDragging: true
            }).on('routesfound', function (e) {
                const routes = e.routes;
                const summary = routes[0].summary; // Láy dữ liệu từ tuyến đường đầu tiên

                // Khoảng cách (mét) và thời gian dự kiến (giây)
                const distance = summary.totalDistance / 1000; // Đổi sang km
                const time = summary.totalTime / 60; // đổi ra phút

                // Hiển thị khoảng cách và thời gian dự kiến
                document.getElementById('routeInfo').innerHTML = `Khoảng cách: ${distance.toFixed(2)} km, Thời gian dự kiến: ${time.toFixed(2)} phút`;

                // Lưu vào localStorage
                localStorage.setItem('route_info', JSON.stringify({
                    distance: distance.toFixed(2),
                    time: time.toFixed(2)
                }));
            }).addTo(map);
        }

        window.onload = function () {
            const storedSource = JSON.parse(localStorage.getItem('loc_source'));
            const storedDestination = JSON.parse(localStorage.getItem('loc_destination'));
            if (storedSource) markLocation(storedSource.lat, storedSource.lon, storedSource.display_name, true);
            if (storedDestination) markLocation(storedDestination.lat, storedDestination.lon, storedDestination.display_name, false);
            if (storedSource && storedDestination) drawRoute(storedSource, storedDestination);
        };


        function searchLocation(query, callback) {
            const url = `https://photon.komoot.io/api/?q=${query}&limit=5`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data && data.features.length > 0) {
                        callback(data.features.map(feature => ({
                            display_name: feature.properties.name,
                            lat: feature.geometry.coordinates[1],
                            lon: feature.geometry.coordinates[0]
                        })));
                    }
                });
        }

        function displaySuggestions(data, suggestionBox, isSource) {
            suggestionBox.innerHTML = '';
            data.forEach(item => {
                const li = document.createElement('li');
                li.className = 'suggestion-item';
                li.textContent = `${item.display_name}`;
                li.addEventListener('click', () => {
                    markLocation(item.lat, item.lon, item.display_name, isSource);
                    suggestionBox.innerHTML = ''; // Xóa gợi ý khi chọn
                });
                suggestionBox.appendChild(li);
            });
        }

        const locSourceInput = document.getElementById('loc_source');
        const locDestinationInput = document.getElementById('loc_destination');
        const sourceSuggestions = document.getElementById('sourceSuggestions');
        const destinationSuggestions = document.getElementById('destinationSuggestions');

        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        locSourceInput.addEventListener('input', debounce(function () {
            const query = locSourceInput.value;
            if (query.length > 2) {
                searchLocation(query, data => displaySuggestions(data, sourceSuggestions, true));
            }
        }, 500)); // 500ms delay

        locDestinationInput.addEventListener('input', debounce(function () {
            const query = locDestinationInput.value;
            if (query.length > 2) {
                searchLocation(query, data => displaySuggestions(data, destinationSuggestions, false));
            }
        }, 500)); // 500ms delay

        // ----------------------------- Sau khi customer ấn "Search" -----------------------------

        // Hàm gửi loc_source và loc_destination đến Backend
        async function searchDrivers() {
            const loc_source = JSON.parse(localStorage.getItem('loc_source'));
            const loc_destination = JSON.parse(localStorage.getItem('loc_destination'));

            if (loc_source && loc_destination) {
                // console.log("loc_source display: ", loc_source.display_name);
                // console.log("loc_destination: ", loc_destination);

                const response = await fetch('http://localhost:8080/api/search-drivers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        loc_source: loc_source,  // Snake case để phù hợp với @JsonProperty trên backend
                        loc_destination: loc_destination,  // Snake case để phù hợp với @JsonProperty trên backend
                        // display_name_source: loc_source.display_name,
                        // display_name_destination: loc_destination.display_name
                    })
                });

                const drivers = await response.json();
                // Log dữ liệu tài xế nhận được từ Backend
                console.log("Drivers received from backend:", drivers);
                // Trả lại price dựa theo khoảng cách loc_source, loc_destination (backend || price = distance *)
                displayDriversOnMap(drivers);
                displayDriverList(drivers);
            }
        }



        // Hàm hiển thị vị trí các tài xế gần nhất trên bản đồ
        function displayDriversOnMap(drivers) {
            drivers.forEach(driver => {                       //1 driver có dạng: {driverId: 10, name: 'Tony', location: {lat:20.8824514, lon:106.0375673}, distance: 24.239102445215433}
                // Kiểm tra xem driver có dữ liệu lat và lon không
                if (driver.location.lat && driver.location.lon) {
                    L.marker([driver.location.lat, driver.location.lon])
                        .addTo(map)
                        .bindPopup(`Driver: ${driver.name}`)
                        .openPopup();
                } else {
                    console.error(`Driver with ID ${driver.name} has invalid coordinates: lat = ${driver.lat}, lon = ${driver.lon}`);
                }
            });
        }

        // Hàm hiển thị danh sách tài xế gần nhất để chọn 
        function displayDriverList(drivers) {
            const routeInfo = JSON.parse(localStorage.getItem('route_info'));
            const driverList = document.getElementById('driverList');
            driverList.innerHTML = ''; // xóa ds cũ
            drivers.forEach(driver => {
                const li = document.createElement('li');
                li.textContent = `Tài xế: ${driver.name} - Đang cách điểm đón: ${driver.distance} km - Price: ${routeInfo.distance * 1.2} $`; // [?] backend gửi thêm price = distance * 5.500 vnđ

                li.addEventListener('click', function () {
                    document.getElementById('tripPayment').style.display = 'block'; // Corrected display logic
                    const detailDiv = document.getElementById('paymentDetail'); // Hiển thị paymentDetail: price, voucher, total
                    detailDiv.innerHTML = ''; // xóa ds cũ
                    detailDiv.innerHTML = `
                        <p>Price: ${routeInfo.distance * 1.2} $</p>
                        <p>Voucher: -${1.5} $</p>
                        <p>Total: ${routeInfo.distance * 1.2 - 1.5} $</p>                        
                    `;

                    showPaymentForm(driver); // Attach event listeners to payment buttons
                });
                driverList.appendChild(li);
            });
        }

        // Hàm xử lý khi ấn nút "Pay Now" hoặc "Ok" trên Payment Form
        function showPaymentForm(driver) {
            const payNowBtn = document.getElementById('payNowBtn');
            const okBtn = document.getElementById('okBtn');
            const routeInfo = JSON.parse(localStorage.getItem('route_info'));


            // Remove existing event listeners to avoid duplication
            payNowBtn.replaceWith(payNowBtn.cloneNode(true));
            okBtn.replaceWith(okBtn.cloneNode(true));

            const newPayNowBtn = document.getElementById('payNowBtn');
            const newOkBtn = document.getElementById('okBtn');

            // Attach event listener for "Pay Now"
            newPayNowBtn.addEventListener('click', function () {
                const methodValue = document.getElementById('method').value;
                const paymentRequest = {
                    price: routeInfo.distance * 1.2,
                    voucher: 1.5,
                    total: routeInfo.distance * 1.2 - 1.5,
                    method: methodValue,
                    status: "Paid"
                };

                document.getElementById('tripPayment').style.display = 'none'; 

                handleDriverSelection(driver, paymentRequest);
            });

            // Attach event listener for "Ok"
            newOkBtn.addEventListener('click', function () {
                const methodValue = document.getElementById('method').value;
                const paymentRequest = {
                    price: routeInfo.distance * 1.2,
                    voucher: 1.5,
                    total: routeInfo.distance * 1.2 - 1.5,
                    method: methodValue,
                    status: "Unpaid"
                };
                
                document.getElementById('tripPayment').style.display = 'none'; 

                handleDriverSelection(driver, paymentRequest);
            });
        }

        // Hàm xử lý sau khi customer chọn tài xế từ danh sách rồi nhập payment form
        function handleDriverSelection(driver, paymentRequest) {
            const loc_source = JSON.parse(localStorage.getItem('loc_source'));
            const loc_destination = JSON.parse(localStorage.getItem('loc_destination'));
            const routeInfo = JSON.parse(localStorage.getItem('route_info'));


            fetch('http://localhost:8080/api/request-driver', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    driverId: driver.driverId,
                    customerId: customerId,
                    loc_source: loc_source,
                    loc_destination: loc_destination,
                    distance: routeInfo.distance,
                    payment_request: paymentRequest
                })
            })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'accepted') {
                        alert(`Tài xế ${driver.name} đã nhận yêu cầu. Khoảng cách: ${driver.distance} km, Thời gian dự kiến: ${result.estimatedTime} phút`);
                    } else if (result.status === 'declined') {
                        alert(`Tài xế ${driver.name} đã từ chối yêu cầu. Vui lòng chọn tài xế khác.`);
                    } else if (result.status === 'timeout') {
                        alert(`Tài xế ${driver.name} không phản hồi.`);
                    }
                })
                .catch(error => {
                    console.error('Lỗi khi gửi yêu cầu đến tài xế', error);
                });
        }

        // Xử lý khi người dùng ấn nút Create thay vì nút Search

        document.getElementById('createBtn').addEventListener('click', function () {
            const routeInfo = JSON.parse(localStorage.getItem('route_info'));
            document.getElementById('tripPayment').style.display = 'block'; 
            const detailDiv = document.getElementById('paymentDetail'); // Hiển thị paymentDetail: price, voucher, total
            detailDiv.innerHTML = ''; //xóa ds cũ
            detailDiv.innerHTML = `
                <p>Price: ${routeInfo.distance * 1.2} $</p>
                <p>Price: -${1.5} $</p>
                <p>Price: ${routeInfo.distance * 1.2 - 1.5} $</p>
            `;

            // Hàm xử lý khi customer nhập payment form xong và ấn "Pay Now" hoặc "Ok"
            showPaymentFormV2();

        });


        // Hàm xử lý khi ấn nút "Pay Now" hoặc "Ok" trên Payment Form
        function showPaymentFormV2() {
            const payNowBtn = document.getElementById('payNowBtn');
            const okBtn = document.getElementById('okBtn');
            const routeInfo = JSON.parse(localStorage.getItem('route_info'));


            // Remove existing event listeners to avoid duplication
            payNowBtn.replaceWith(payNowBtn.cloneNode(true));
            okBtn.replaceWith(okBtn.cloneNode(true));

            const newPayNowBtn = document.getElementById('payNowBtn');
            const newOkBtn = document.getElementById('okBtn');

            // Attach event listener for "Pay Now"
            newPayNowBtn.addEventListener('click', function () {
                const methodValue = document.getElementById('method').value;
                const paymentRequest = {
                    price: routeInfo.distance * 1.2,
                    voucher: 1.5,
                    total: routeInfo.distance * 1.2 - 1.5,
                    method: methodValue,
                    status: "Paid"
                };

                document.getElementById('tripPayment').style.display = 'none'; 

                handleDriverSelectionV2(paymentRequest);
            });

            // Attach event listener for "Ok"
            newOkBtn.addEventListener('click', function () {
                const methodValue = document.getElementById('method').value;
                const paymentRequest = {
                    price: routeInfo.distance * 1.2,
                    voucher: 1.5,
                    total: routeInfo.distance * 1.2 - 1.5,
                    method: methodValue,
                    status: "Unpaid"
                };
                
                document.getElementById('tripPayment').style.display = 'none'; 

                handleDriverSelectionV2(paymentRequest);
            });
        }

        // Hàm xử lý sau khi customer chọn tài xế từ danh sách rồi nhập payment form
        function handleDriverSelectionV2(paymentRequest) {
            const loc_source = JSON.parse(localStorage.getItem('loc_source'));
            const loc_destination = JSON.parse(localStorage.getItem('loc_destination'));
            const routeInfo = JSON.parse(localStorage.getItem('route_info'));


            fetch('http://localhost:8080/api/request-driver-v2', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    driverId: 0,// ko có do đang để hệ thống tự chọn 
                    customerId: customerId,
                    loc_source: loc_source,
                    loc_destination: loc_destination,
                    distance: routeInfo.distance,
                    payment_request: paymentRequest
                })
            })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'accepted') {
                        alert(`Đã có tài xế nhận yêu cầu chuyến đi. Đang cách điểm đón: ${result.distance} km, Dự kiến đến nơi sau: ${result.estimatedTime} phút`);
                    } else {
                        alert(`${result.status}`);// ko ai nhận (tất cả tài xế ấn deny)
                    }
                })
                .catch(error => {
                    console.error('Lỗi khi gửi yêu cầu đến tài xế', error);
                });
        }
        
        // =================================================================
        // Xử lý khi người dùng ấn nút Search ---------------------
        document.getElementById('searchBtn').addEventListener('click', searchDrivers);

        // ------------------------- Lịch sử chuyến đi "My Trip" ---------------------------
        // Hàm lấy ra tất cả trips khi người dùng click vào "My Trip"

        let offset = 0;

        document.getElementById("myTripBtn").addEventListener("click", function () {
            fetchTrips();
        });

        function fetchTrips() {
            fetch('http://localhost:8080/trips/my-trips', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: customerId, offset: offset })
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    document.getElementById("tripList").style.display = 'block';
                    updateTripsTable(data);

                    offset == 0 ? document.getElementById("backBtn").style.display = 'none' : document.getElementById("backBtn").style.display = 'block';

                    if (data.length === 10) {
                        document.getElementById("loadMoreBtn").style.display = 'block'; // Hiển thị nút "Load More" nếu còn dữ liệu
                    } else {
                        document.getElementById("loadMoreBtn").style.display = 'none'; // Ẩn nút nếu không còn dữ liệu
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function updateTripsTable(trips) {
            const tableBody = document.querySelector('#tripTable tbody');
            tableBody.innerHTML = ''; // Xóa dữ liệu cũ trong bảng

            trips.forEach(trip => {
                const sourceLocation = JSON.parse(trip.source);
                const destinationLocation = JSON.parse(trip.destination);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${trip.tripId}</td>
                    <td>${trip.status}</td>
                    <td>${sourceLocation.display_name}</td>
                    <td>${destinationLocation.display_name}</td>
                    <td>${new Date(trip.createdAt).toLocaleString()}</td>
                `;

                const actionTd = document.createElement('td');

                // Nút SeeDetail
                const seeDetailButton = document.createElement('button');
                seeDetailButton.textContent = 'SeeDetail';
                seeDetailButton.addEventListener('click', function () {
                    // alert('Displaying details for trip: ' + trip.tripId);
                    // function seeDetail();
                    seeTripDetail(trip.tripId);
                });
                actionTd.appendChild(seeDetailButton);

                // Nút Cancel cho status 1 hoặc 2
                if (trip.status === '1' || trip.status === '2') {
                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = 'Cancel';
                    cancelButton.addEventListener('click', function () {
                        cancelTrip(trip.tripId);
                    });
                    actionTd.appendChild(cancelButton);
                }

                // Nút Rating cho status 4
                if (trip.status === '4') {
                    const ratingButton = document.createElement('button');
                    ratingButton.textContent = 'Rating';
                    ratingButton.addEventListener('click', function () {
                        // alert('Rating driver for trip: ' + trip.tripId);
                        document.getElementById('tripRating').style.display = 'block'; // Hiện form đánh giá

                        showRatingForm(trip.tripId); // Hàm xử lý sau khi gửi đánh giá (lắng nghe sự kiến ấn nút Send Rating)
                    });
                    actionTd.appendChild(ratingButton);
                }

                row.appendChild(actionTd);
                tableBody.appendChild(row);
            });

        }
        // Hàm xử lý yêu cầu hủy chuyến đi đến Backend (cancel trip)
        function cancelTrip(tripId) {
            fetch('http://localhost:8080/trips/cancel', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    tripId: tripId
                })
            })
                .then(response => response.text())
                .then(data => {
                    alert('Trip canceled successfully!');
                    // document.getElementById("myTripBtn").click();
                    // Refresh lại danh sách sau khi hủy
                    offset = 0;
                    fetchTrips();
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function getTripStatus(status) {
            switch (status) {
                case '1': return 'in-progress';
                case '2': return 'Accepted';
                case '3': return 'Received Guest';
                case '4': return 'Completed';
                default: return 'Canceled';
            }
        }

        // Hàm xử lý hiển thị chi tiết đơn hàng (SeeDetail)
        function seeTripDetail(tripId) {
            fetch(`http://localhost:8080/payments/trip/${tripId}`)
                .then(response => response.json())
                .then(payment => {
                    displayTripDetail(payment);
                    console.log("payment: ", payment);
                    console.log("payment detail: ", payment.price, payment.total, payment.voucher, payment.paymentStatus, payment.paymentMethod);
                })
                .catch(error => {
                    console.error('Error fetching trip detail:', error);
                });
        }

        function displayTripDetail(payment) {
            const detailDiv = document.getElementById('tripDetail');
            detailDiv.innerHTML = `
                <p>Price: ${payment.price} $</p>
                <p>Voucher: - ${payment.voucher || 0} $</p>
                <p>Total: ${payment.total} $</p>
                <p>Payment Status: ${payment.paymentStatus}</p>
                <p>Payment Method: ${getPaymentMethod(payment.paymentMethod)}</p>`;
        }

        function getPaymentMethod(method) {
            switch (method) {
                case '1': return 'Cash';
                case '2': return 'E-Wallet';
                case '3': return 'Online Banking';
                default: return 'Unknown';
            }
        }

        // Hàm xử lý form đánh giá (Rating) 
        function showRatingForm(tripId) {
            document.getElementById('sendRatingBtn').addEventListener('click', function () {
                const ratingValue = document.getElementById('rating').value;
                const feedbackValue = document.getElementById('feedback').value;
                sendRating(tripId, ratingValue, feedbackValue);
            });
        }

        function sendRating(tripId, rating, feedback) {
            fetch('http://localhost:8080/trips/rate-trip', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    tripId: tripId,
                    rating: rating,
                    feedback: feedback
                })
            })
                .then(response => response.text())
                .then(data => {
                    // alert('Rating submitted successfully!');
                    console.log(data);
                    // Optionally reload the table to reflect the updated state
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }


        // Hàm để tải thêm chuyến đi khi ấn nút "Load More"
        document.getElementById("loadMoreBtn").addEventListener("click", function () {
            offset += 1; // Tăng offset (currentPage)
            fetchTrips(); // Lấy thêm các chuyến đi
        });

        document.getElementById("backBtn").addEventListener("click", function () {
            offset -= 1; // Tăng offset (currentPage)
            fetchTrips(); // Lấy thêm các chuyến đi
        });




        // Hàm lấy ra route chi tiết của một đơn hàng khi đã hoàn thành, và đánh dấu nó trên bản đồ sử dụng các dấu chấm
        function getTripRoute(driverId) {
            fetch(`http://localhost:8080/trips/${tripId}/route`)
                .then(response => response.json())
                .then(locations => {
                    locations.forEach(location => {
                        // Thêm marker cho mỗi vị trí
                        addMarker(location.lat, location.lon);
                    });
                })
                .catch(error => console.error('Error:', error));
        }
    </script>
</body>

</html>


<!-- // Hàm hiển thị danh sách tài xế gần nhất để chọn 
function displayDriverList(drivers) {
    const driverList = document.getElementById('driverList');
    driverList.innerHTML = ''; // Xóa danh sách cũ

    drivers.forEach(driver => {
        const li = document.createElement('li');
        li.textContent = `Tài xế: ${driver.name} - Khoảng cách: ${driver.distance} km - Price: ${driver.price} $`;

        li.addEventListener('click', function () {
            document.getElementById('tripPayment').style.display = 'block'; // Hiển thị form thanh toán
            const detailDiv = document.getElementById('paymentDetail'); // Hiển thị paymentDetail: price, voucher, total
            detailDiv.innerHTML = `
                <p>Price: ${driver.price} $</p>
                <p>Voucher: -${1.5} $</p>
                <p>Total: ${driver.price - 1.5} $</p>                        
            `;
            showPaymentForm(driver); // Gọi hàm để xử lý thanh toán
        });
        driverList.appendChild(li);
    });
}

// Hàm xử lý khi ấn nút "Pay Now" hoặc "Ok" trên Payment Form 
function showPaymentForm(driver) {
    // Khi ấn nút "Pay Now"
    document.getElementById('payNowBtn').addEventListener('click', function () {
        const methodValue = document.getElementById('method').value;
        // Tạo đối tượng paymentRequest
        const paymentRequest = JSON.stringify({
            price: driver.price, 
            voucher: 1.5, 
            total: driver.price - 1.5, 
            method: methodValue, 
            status: "Paid"
        });

        handleDriverSelection(driver, paymentRequest);
    });

    // Khi ấn nút "Ok"
    document.getElementById("okBtn").addEventListener('click', function () {
        const methodValue = document.getElementById('method').value;
        // Tạo đối tượng paymentRequest
        const paymentRequest = JSON.stringify({
            price: driver.price,
            voucher: 1.5,
            total: driver.price - 1.5,
            method: methodValue,
            status: "Unpaid"
        });

        handleDriverSelection(driver, paymentRequest);
    });
}

// Hàm xử lý khi customer chọn tài xế từ danh sách
function handleDriverSelection(driver, paymentRequest) {
    const loc_source = JSON.parse(localStorage.getItem('loc_source'));
    const loc_destination = JSON.parse(localStorage.getItem('loc_destination'));

    fetch('http://localhost:8080/api/request-driver', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            driverId: driver.driverId,
            customerId: customerId,
            loc_source: loc_source,
            loc_destination: loc_destination, 
            distance: driver.distance,
            payment_request: paymentRequest
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'accepted') {
            alert(`Tài xế ${driver.name} đã nhận yêu cầu. Khoảng cách: ${driver.distance} km, Thời gian dự kiến: ${result.estimatedTime} phút`);
        } else if (result.status === 'declined') {
            alert(`Tài xế ${driver.name} đã từ chối yêu cầu. Vui lòng chọn tài xế khác.`);
        }
    })
    .catch(error => {
        console.error('Lỗi khi gửi yêu cầu đến tài xế', error);
    });
} -->