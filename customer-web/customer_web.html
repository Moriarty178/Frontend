<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Web</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <style>
        #map {
            height: 900px;
            width: 100%;
        }

        /* CSS cho danh sách gợi ý */
        .suggestions {
            border: 1px solid #ddd;
            max-height: 150px;
            overflow-y: auto;
        }

        .suggestion-item {
            padding: 8px;
            cursor: pointer;
            background-color: white;
        }

        .suggestion-item:hover {
            background-color: #f0f0f0;
        }

        .trip-table {
            width: 100%;
            border-collapse: collapse;
        }

        .trip-table th,
        .trip-table td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        .trip-table th {
            background-color: #f2f2f2;
            text-align: left;
        }

        .trip-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .trip-table tr:hover {
            background-color: #ddd;
        }
    </style>
</head>

<body>
    <div>
        <label for="loc_source">Điểm đón:</label>
        <input type="text" id="loc_source" placeholder="Nhập điểm đón">
        <ul id="sourceSuggestions" class="suggestions"></ul> <!-- Danh sách gợi ý -->
        <br>
        <label for="loc_destination">Điểm trả:</label>
        <input type="text" id="loc_destination" placeholder="Nhập điểm trả">
        <ul id="destinationSuggestions" class="suggestions"></ul> <!-- Danh sách gợi ý -->
        <br>
        <!-- Nút Search -->
        <button id="searchBtn">Search</button>

        <!-- Phần hiển thị danh sách tài xế gần nhât backend gửi lên -->
        <ul id="driverList"></ul>


        <button id="myTripBtn">My Trip</button>
        <button id="loadMoreBtn" style="display: none;">Load More</button>

        <!-- Hiển thị danh sách các chuyến đi -->
        <!-- Hiển thị danh sách các chuyến đi -->
        <div id="tripList">
            <table id="tripTable" class="trip-table">
                <thead>
                    <tr>
                        <th>Trip ID</th>
                        <th>Status</th>
                        <th>Source</th>
                        <th>Destination</th>
                        <th>Created At</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Hàng dữ liệu sẽ được chèn vào đây -->
                </tbody>
            </table>
        </div>

    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script>
        let customerId = 1234;
        var map = L.map('map').setView([21.0285, 105.8542], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        let locSourceMarker, locDestinationMarker, routeLayer;

        // --------------------------- Chọn điểm đón, trả --------------------------
        // Hàm đánh dấu vị trí
        function markLocation(lat, lon, display_name, isSource) {
            if (isSource) {
                // Xóa marker cũ của điểm đón nếu có
                if (locSourceMarker) {
                    map.removeLayer(locSourceMarker);
                    delete locSourceMarker;
                }
                // Thêm marker mới cho điểm đón
                locSourceMarker = L.marker([lat, lon]).addTo(map).bindPopup('Điểm đón').openPopup();
                localStorage.setItem('loc_source', JSON.stringify({ lat, lon, display_name }));

                // Xóa tuyến đường cũ khi thay đổi điểm đón: nếu không thì vẫn sẽ thấy điểm đón cũ BỞI VÌ marker thì đã mất(do xóa ở trên) nhưng route thì vẫn còn đó (route và 2 điểm đón, trả là dộc lập với nhau. Xóa đón trả ko đồng nghĩa xóa được route)
                if (routeLayer) {
                    map.removeControl(routeLayer);
                }
            } else {
                // Xóa marker cũ của điểm trả nếu có
                if (locDestinationMarker) {
                    map.removeLayer(locDestinationMarker);
                    delete locDestinationMarker;
                }
                // Thêm marker mới cho điểm trả
                locDestinationMarker = L.marker([lat, lon]).addTo(map).bindPopup('Điểm trả').openPopup();
                localStorage.setItem('loc_destination', JSON.stringify({ lat, lon, display_name }));

                // Xóa tuyến đường cũ khi thay đổi điểm trả
                if (routeLayer) {
                    map.removeControl(routeLayer);
                }
            }

            // Kiểm tra và vẽ lại tuyến đường khi cả hai điểm đón và trả đã có
            const storedSource = JSON.parse(localStorage.getItem('loc_source'));
            const storedDestination = JSON.parse(localStorage.getItem('loc_destination'));
            if (storedSource && storedDestination) {
                drawRoute(storedSource, storedDestination);
            }
        }

        // Hàm vẽ tuyến đường
        function drawRoute(source, destination) {
            // Xóa tuyến đường cũ nếu có
            if (routeLayer) {
                map.removeControl(routeLayer);
            }

            // Vẽ tuyến đường mới
            routeLayer = L.Routing.control({
                waypoints: [
                    L.latLng(source.lat, source.lon),
                    L.latLng(destination.lat, destination.lon)
                ],
                routeWhileDragging: true
            }).addTo(map);
        }

        window.onload = function () {
            const storedSource = JSON.parse(localStorage.getItem('loc_source'));
            const storedDestination = JSON.parse(localStorage.getItem('loc_destination'));
            if (storedSource) markLocation(storedSource.lat, storedSource.lon, storedSource.display_name, true);
            if (storedDestination) markLocation(storedDestination.lat, storedDestination.lon, storedDestination.display_name, false);
            if (storedSource && storedDestination) drawRoute(storedSource, storedDestination);
        };


        // function searchLocation(query, callback) {
        //     const url = `https://nominatim.openstreetmap.org/search?format=json&q=${query}`;//dùng api nominatim để đề xuất địa điểm 
        //     fetch(url)
        //         .then(response => response.json())
        //         .then(data => {
        //             if (data && data.length > 0) {
        //                 callback(data);
        //             }
        //         });
        // }

        function searchLocation(query, callback) {
            const url = `https://photon.komoot.io/api/?q=${query}&limit=5`;//dùng photon cho đề xuất địa điểm 
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data && data.features.length > 0) {
                        callback(data.features.map(feature => ({
                            display_name: feature.properties.name,
                            lat: feature.geometry.coordinates[1],
                            lon: feature.geometry.coordinates[0]
                        })));
                    }
                });
        }

        function displaySuggestions(data, suggestionBox, isSource) {
            suggestionBox.innerHTML = '';
            data.forEach(item => {
                const li = document.createElement('li');
                li.className = 'suggestion-item';
                li.textContent = `${item.display_name}`;
                li.addEventListener('click', () => {
                    markLocation(item.lat, item.lon, item.display_name, isSource);
                    suggestionBox.innerHTML = ''; // Xóa gợi ý khi chọn
                });
                suggestionBox.appendChild(li);
            });
        }

        const locSourceInput = document.getElementById('loc_source');
        const locDestinationInput = document.getElementById('loc_destination');
        const sourceSuggestions = document.getElementById('sourceSuggestions');
        const destinationSuggestions = document.getElementById('destinationSuggestions');

        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        locSourceInput.addEventListener('input', debounce(function () {
            const query = locSourceInput.value;
            if (query.length > 2) {
                searchLocation(query, data => displaySuggestions(data, sourceSuggestions, true));
            }
        }, 500)); // 500ms delay

        locDestinationInput.addEventListener('input', debounce(function () {
            const query = locDestinationInput.value;
            if (query.length > 2) {
                searchLocation(query, data => displaySuggestions(data, destinationSuggestions, false));
            }
        }, 500)); // 500ms delay

        // ----------------------------- Sau khi customer ấn "Search" -----------------------------

        // Hàm gửi loc_source và loc_destination đến Backend
        async function searchDrivers() {
            const loc_source = JSON.parse(localStorage.getItem('loc_source'));
            const loc_destination = JSON.parse(localStorage.getItem('loc_destination'));

            if (loc_source && loc_destination) {
                // console.log("loc_source display: ", loc_source.display_name);
                // console.log("loc_destination: ", loc_destination);

                const response = await fetch('http://localhost:8080/api/search-drivers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        loc_source: loc_source,  // Snake case để phù hợp với @JsonProperty trên backend
                        loc_destination: loc_destination,  // Snake case để phù hợp với @JsonProperty trên backend
                        // display_name_source: loc_source.display_name,
                        // display_name_destination: loc_destination.display_name
                    })
                });

                const drivers = await response.json();
                // Log dữ liệu tài xế nhận được từ Backend
                console.log("Drivers received from backend:", drivers);
                displayDriversOnMap(drivers);
                displayDriverList(drivers);
            }
        }



        // Hàm hiển thị vị trí các tài xế gần nhất trên bản đồ
        function displayDriversOnMap(drivers) {
            drivers.forEach(driver => {                       //1 driver có dạng: {driverId: 10, name: 'Tony', location: {lat:20.8824514, lon:106.0375673}, distance: 24.239102445215433}
                // Kiểm tra xem driver có dữ liệu lat và lon không
                if (driver.location.lat && driver.location.lon) {
                    L.marker([driver.location.lat, driver.location.lon])
                        .addTo(map)
                        .bindPopup(`Driver: ${driver.name}`)
                        .openPopup();
                } else {
                    console.error(`Driver with ID ${driver.name} has invalid coordinates: lat = ${driver.lat}, lon = ${driver.lon}`);
                }
            });
        }

        // Hàm hiển thị danh sách tài xế gần nhất để chọn 
        function displayDriverList(drivers) {
            const driverList = document.getElementById('driverList');
            driverList.innerHTML = '';// xóa ds cũ
            drivers.forEach(driver => {
                const li = document.createElement('li');
                li.textContent = `Tài xế: ${driver.name} - Khoảng cách: ${driver.distance} km`;
                li.addEventListener('click', () => handleDriverSelection(driver)); // Thêm sự kiện khi click vào tài xế
                driverList.appendChild(li);
            });
        }

        // Hàm xử lý khi customer chọn tài xế từ danh sách
        function handleDriverSelection(driver) {
            const loc_source = JSON.parse(localStorage.getItem('loc_source'));
            const loc_destination = JSON.parse(localStorage.getItem('loc_destination'));

            // console.log("loc_source : ", loc_source);
            // console.log("loc_destination: ", loc_destination);


            fetch('http://localhost:8080/api/request-driver', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    driverId: driver.driverId,
                    customerId: customerId,
                    loc_source: loc_source,// lấy tên địa điểm mà customer chọn từ photon đề xuất
                    loc_destination: loc_destination, // lấy tên địa điểm
                    distance: driver.distance
                })
            })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'accepted') {
                        alert(`Tài xế ${driver.name} đã nhận yêu cầu. Khoảng cách: ${driver.distance} km, Thời gian dự kiến: ${result.estimatedTime} phút`);
                    } else if (result.status === 'declined') {
                        alert(`Tài xế ${driver.name} đã từ chối yêu cầu. Vui lòng chọn tài xế khác.`);
                    }
                })
                .catch(error => {
                    console.error('Lỗi khi gửi yêu cầu đến tài xế', error);
                });
        }

        // Xử lý khi người dùng ấn nút Search
        document.getElementById('searchBtn').addEventListener('click', searchDrivers);

        // ------------------------- Lịch sử chuyến đi "My Trip" ---------------------------
        // Hàm lấy ra tất cả trips khi người dùng click vào "My Trip"

        let offset = 0;

        document.getElementById("myTripBtn").addEventListener("click", function () {
            fetchTrips();
        });

        function fetchTrips() {
            fetch('http://localhost:8080/trips/my-trips', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ customerId: customerId, offset: offset })
            })
                .then(response => response.json())
                .then(data => {
                    // console.log(data);
                    updateTripsTable(data);

                    if (data.length === 10) {
                        document.getElementById("loadMoreBtn").style.display = 'block'; // Hiển thị nút "Load More" nếu còn dữ liệu
                    } else {
                        document.getElementById("loadMoreBtn").style.display = 'none'; // Ẩn nút nếu không còn dữ liệu
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function updateTripsTable(trips) {
            const tableBody = document.querySelector('#tripTable tbody');
            tableBody.innerHTML = ''; // Xóa dữ liệu cũ trong bảng

            trips.forEach(trip => {
                const sourceLocation = JSON.parse(trip.source);
                const destinationLocation = JSON.parse(trip.destination);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${trip.tripId}</td>
                    <td>${trip.status}</td>
                    <td>${sourceLocation.display_name}</td>
                    <td>${destinationLocation.display_name}</td>
                    <td>${new Date(trip.createdAt).toLocaleString()}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Hàm để tải thêm chuyến đi khi ấn nút "Load More"
        document.getElementById("loadMoreBtn").addEventListener("click", function () {
            offset += 1; // Tăng offset (currentPage)
            fetchTrips(); // Lấy thêm các chuyến đi
        });



        // Hàm lấy ra route chi tiết của một đơn hàng khi đã hoàn thành, và đánh dấu nó trên bản đồ sử dụng các dấu chấm
        function getTripRoute(driverId) {
            fetch(`http://localhost:8080/trips/${tripId}/route`)
                .then(response => response.json())
                .then(locations => {
                    locations.forEach(location => {
                        // Thêm marker cho mỗi vị trí
                        addMarker(location.lat, location.lon);
                    });
                })
                .catch(error => console.error('Error:', error));
        }
    </script>
</body>

</html>