<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Web</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 50px;
        }

        #status {
            margin-bottom: 20px;
        }

        #location {
            margin-bottom: 20px;
        }

        #alerts {
            color: red;
            font-weight: bold;
        }

        .form-container {
            margin-bottom: 30px;
        }

        .form-container input {
            margin: 5px;
            padding: 10px;
            width: 200px;
        }

        .form-container button {
            padding: 10px 20px;
            margin-top: 10px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>

    <h1>Driver Web</h1>

    <!-- Đăng nhập form -->
    <div id="login-form" class="form-container">
        <h2>Login</h2>
        <input type="email" id="login-email" placeholder="Email" required />
        <input type="password" id="login-password" placeholder="Password" required />
        <button onclick="login()">Login</button>
        <div id="login-message"></div>
    </div>

    <!-- Đăng ký form -->
    <div id="signup-form" class="form-container">
        <h2>Sign Up</h2>
        <input type="text" id="signup-firstname" placeholder="First Name" required />
        <input type="text" id="signup-lastname" placeholder="Last Name" required />
        <input type="email" id="signup-email" placeholder="Email" required />
        <input type="password" id="signup-password" placeholder="Password" required />
        <input type="text" id="signup-phone" placeholder="Phone Number" required />
        <button onclick="signup()">Sign Up</button>
        <div id="signup-message"></div>
    </div>
    <!-- Đăng xuất form -->
     <div class="form-container">
        <h2>Logout</h2>
        <button onclick="logout()">Logout</button>
        <div id="logout-message"></div>
     </div>

    <!-- Giao diện theo dõi vị trí -->
    <div id="status" class="hidden">Status: Disconnected</div>
    <div id="location" class="hidden">Location: Unknown</div>
    <div id="alerts" class="hidden">Alerts: None</div>

    <!-- Hiển thị thông tin driverRequest mà backend gửi đến -->
    <div id="request-info"></div>

    <button id="accept-button" style="display: none;">Chấp nhận</button>
    <button id="deny-button" style="display: none;">Từ chối</button>

     <!-- Nút Trip Received -->
    <button id="myTripBtn">Trip Received</button>
    <button id="backBtn" style="display: none;">Back</button>
    <button id="loadmoreBtn" style="display: none;">Load More</button>

    <!-- Nút Trip List  -->
    <button id="tripListBtn">Trip List</button>
    <button id="backListBtn" style="display: none;">Back List</button>
    <button id="loadmoreListBtn" style="display: none;">Load More List</button>

    <!-- Hiển thị danh sách chuyến đi tài xế có thể nhận thủ công -->
     <div id="tripList" style="display: none;">
        <table id="tripListTable" class="trip-list-table">
            <thead>
                <th>Trip ID</th>
                <th>Status</th>
                <th>Source</th>
                <th>Destination</th>
                <th>Distance</th>
                <th>Total</th>
                <th>Action</th>
            </thead>
            <tbody>
                <!-- Hàng dữ liệu sẽ được chèn vào đây -->
            </tbody>
        </table>
     </div>

    <!-- Hiển thị danh sách chuyến đi đã nhận (Trip Received) -->
    <div id="tripReceived" style="display: none;">
        <table id="tripTable" class="trip-table">
            <thead>
                <tr>
                    <th>Trip ID</th>
                    <th>Status</th>
                    <th>Source</th>
                    <th>Destiantion</th>
                    <th>Distance</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <!-- Hàng dữ liệu sẽ được chèn vào đây -->
            </tbody>
        </table>
    </div>

    <!-- Hiển thị thông tin chi tiết chuyến đi (SeeDetail) -->
     <div id="tripDetail"></div>

    <!-- Bao gồm STOMP.js từ CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <script src="driver_web.js"></script>

    <script>
        let offsetList = 0;

        document.getElementById('tripListBtn').addEventListener('click', function() {
            fetchTripList();
        });

        function fetchTripList() {
            fetch('http://localhost:8080/trips/trip-list', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ offsetList: offsetList })
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);

                document.getElementById('tripList').style.display = 'block'; 
                updateTripsListTable(data);

                offsetList == 0 ? document.getElementById('backListBtn').style.display = 'none' : document.getElementById('backListBtn').style.display = 'block';

                if (data.length === 10) {
                    document.getElementById('loadmoreListBtn').style.display = 'block';
                } else {
                    document.getElementById('loadmoreListBtn').style.display = 'none';
                }
            }).catch(error => {
                console.log('Error:', error);
            })
        }

        function updateTripsListTable(trips) {
            const tableBody = document.querySelector('#tripListTable tbody');
            tableBody.innerHTML = ''; // xóa ds cũ

            trips.forEach(trip => {
                const sourceLocation = JSON.parse(trip.source);
                const destinationLocation = JSON.parse(trip.destination);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${trip.tripId}</td>
                    <td>${trip.status}</td>
                    <td>${sourceLocation.display_name}</td>
                    <td>${destinationLocation.display_name}</td>
                    <td>${trip.distance} Km</td>
                    <td>${(4.5 * 1.2).toFixed(2)} $</td>
                `;

                const actionId = document.createElement('td');
                // Nút "Get It" cho tất cả chuyến đi trong Trip List
                const getItButton = document.createElement('button');
                getItButton.textContent = 'Get It';
                getItButton.addEventListener('click', function() {
                    updateStatusTrip(trip.tripId, "2");
                });

                actionId.appendChild(getItButton);

                row.appendChild(actionId);
                tableBody.appendChild(row);
            });
        }

        document.getElementById('loadmoreListBtn').addEventListener('click', function() {
            offsetList += 1;
            fetchTripList();
        });
        document.getElementById('backListBtn').addEventListener('click', function() {
            offsetList -= 1;
            fetchTripList();
        })



        // ========================================
        let offset = 0;

        document.getElementById('myTripBtn').addEventListener('click', function() {
            fetchTripsReceived();
        });

        function fetchTripsReceived() {
            const driverId = localStorage.getItem('driverId');
            fetch('http://localhost:8080/trips/trips-received', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: driverId, offset: offset })
            })
                .then(response => response.json())
                .then(data =>{ // trips received
                    console.log(data);

                    document.getElementById('tripReceived').style.display = 'block';
                    updateTripsTable(data);

                    offset == 0? document.getElementById('backBtn').style.display = 'none' : document.getElementById('backBtn').style.display = 'block';

                    if (data.length === 10) {
                        document.getElementById('loadmoreBtn').style.display = 'block';
                    } else {
                        document.getElementById('loadmoreBtn').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                })
        }

        function updateTripsTable(trips) {
            const tableBody = document.querySelector('#tripTable tbody');
            tableBody.innerHTML = ''; // Xóa dữ liệu cũ trong bảng

            trips.forEach(trip => {
                const sourceLocation = JSON.parse(trip.source);
                const destinationLocation = JSON.parse(trip.destination);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${trip.tripId}</td>
                    <td>${trip.status}</td>
                    <td>${sourceLocation.display_name}</td>
                    <td>${destinationLocation.display_name}</td>
                    <td>${trip.distance}</td>
                `;

                const actionId = document.createElement('td'); // tạo cột action

                // Nút SeeDetail cho statu "1" -> "4"
                const seeDetailButton = document.createElement('button');
                seeDetailButton.textContent = 'SeeDetail';
                seeDetailButton.addEventListener('click', function() {
                   seeTripDetail(trip.tripId); 
                });
                actionId.appendChild(seeDetailButton);

                // Nút Cancel và "đã đến điểm đón" cho status "2"
                if (trip.status === "2") {

                    // Nút "Cancel"
                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = 'Cancel';
                    cancelButton.addEventListener('click', function() {
                        updateStatusTrip(trip.tripId, "1");
                    });
                    actionId.appendChild(cancelButton);

                    // Nút "Đã đến điểm đón"
                    const receivedButton = document.createElement('button');
                    receivedButton.textContent = 'Received';
                    receivedButton.addEventListener('click', function() {
                        updateStatusTrip(trip.tripId, "3");
                    });
                    actionId.appendChild(receivedButton);
                }
                
                // Nút "Hoàn thành/đã đến điểm trả" cho status "3"
                if (trip.status === "3") {
                    const completeButton = document.createElement('button');
                    completeButton.textContent = 'Complete';
                    completeButton.addEventListener('click', function() {
                        updateStatusTrip(trip.tripId, "4");
                    });
                    actionId.appendChild(completeButton);
                }

                row.appendChild(actionId);
                tableBody.appendChild(row);
            });

        }

        function updateStatusTrip(tripId, status) {
            const driverId = JSON.parse(localStorage.getItem('driverId'));
            
            fetch('http://localhost:8080/trips/update-status-trip', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    tripId: tripId,
                    driverId: driverId,
                    status: status
                })
            })
            .then(response => response.text())
            .then(data => {
                alert('Ok.');

                offset = 0;
                status === "2" ? fetchTripList() : fetchTripsReceived(); 
                // fetchTripsReceived();
                // fetchTripList();
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        // Hàm xử lý hiển thị chi tiết đơn hàng (SeeDetail)
        function seeTripDetail(tripId) {
            fetch(`http://localhost:8080/payments/trip/${tripId}`)
                .then(response => response.json())
                .then(payment => {
                    displayTripDetail(payment);
                    console.log("payment: ", payment);
                    console.log("payment detail: ", payment.price, payment.total, payment.voucher, payment.paymentStatus, payment.paymentMethod);
                })
                .catch(error => {
                    console.error('Error fetching trip detail:', error);
                });
        }

        function displayTripDetail(payment) {
            const divDetail = document.getElementById('tripDetail');
            divDetail.innerHTML = `
                <p>Price: ${payment.price}</p>
                <p>Voucher: - ${payment.voucher || 0} $</p>
                <p>Total: ${payment.total}</p>
                <p>Payment Status: ${payment.paymentStatus}</p>
                <p>Payment Method: ${getPaymentMethod(payment.paymentMethod)}</p>
            `;
        }

        function getPaymentMethod(method) {
            switch (method) {
                case '1' : return "Cash";
                case '2' : return "E-Wallet";
                case '3' : return "Banking Online";
                default: return 'Unknow';
            }
        }
        function getTripStatus(status) {
            switch (status) {
                case '2' : return 'Accepted';
                case '3' : return 'Received Guest';
                case '4' : return 'Completed';
                default: return 'Unknow';
            }
        }

        // Khi click nút "Load More"
        document.getElementById('loadmoreBtn').addEventListener('click', function() {{
            offset += 1;
            fetchTripsReceived();
        }});

        // Khi click nút "Back"
        document.getElementById('backBtn').addEventListener('click', function() {
            offset -= 1;
            fetchTripsReceived();
        });

    </script>
    
</body>
</html>
